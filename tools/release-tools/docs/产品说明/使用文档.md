# Tikkhun Release 工具使用文档

## 1. 产品简介

Tikkhun Release Tools 是一个用于项目打包发布的工具，它提供了简单易用的配置接口，支持自定义打包范围、压缩类型、发布路径、文件名生成等功能，并能通过插件机制扩展额外功能。

## 2. 核心功能

- 自定义文件包含与排除规则
- 支持多种压缩类型
- 灵活的发布路径配置
- 动态生成发布文件名
- 项目信息获取与存储
- 文件移动与重命名
- 插件扩展机制

## 3. 安装与基本使用

### 3.1 安装

在项目中安装 Tikkhun Release 工具：

```bash
pnpm add @tikkhun/release -D
```

### 3.2 基本使用

#### 命令行方式

```bash
# 使用默认配置
npx tikkhun-release

# 使用配置文件
npx tikkhun-release config -c ./release.json

# 直接传递参数
npx tikkhun-release --workspace ./ --archiveType zip --clean true
```

#### 编程方式

```javascript
import { TikkhunRelease } from '@tikkhun/release-tools';

// 使用默认配置
await TikkhunRelease();

// 传入自定义配置
await TikkhunRelease({
  workspace: './',
  include: ['**/*'],
  exclude: ['**/node_modules/**'],
  archiveType: 'zip',
  clean: true,
  releasePath: 'release'
});
```

## 4. 参数详解

### 4.1 打包发布基础参数

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `workspace` | `string` | `process.cwd()` | 项目根目录，指定要打包的工作空间路径 |
| `include` | `string[]` | `['**/*']` | 包含的文件模式列表，使用 glob 语法 |
| `exclude` | `string[]` | `['**/node_modules/**', '**/release/**', '**/deploy/**', '**/.git/**', '**/.vscode/**']` | 排除的文件模式列表，使用 glob 语法 |
| `archiveType` | `string` | `'zip'` | 压缩类型，目前支持 `'zip'` 和 `'tar'` |
| `archiveOptions` | `object` | 见下方说明 | 压缩选项，用于配置压缩级别等参数 |
| `clean` | `boolean` | `true` | 是否在打包前清空旧的发布文件 |
| `releasePathRelative` | `string` | `'cwd'` | 发布路径的相对位置，可选 `'cwd'`（当前工作目录）或 `'workspace'`（工作空间目录） |
| `releasePath` | `string` | `'release'` | 发布文件夹的名称或路径 |

**archiveOptions 默认值说明**：
- 当 `archiveType` 为 `'tar'` 时：`{ gzip: true, gzipOptions: { level: 9 } }`
- 当 `archiveType` 为 `'zip'` 时：`{ zlib: { level: 9 } }`

### 4.2 信息管理参数

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `getInfoOptions.from` | `Array` | 见下方说明 | 项目信息的来源配置，用于获取项目信息 |

**getInfoOptions.from 默认值**：

```javascript
[
  [
    'package.json',
    {
      name: 'name',
      version: 'version',
      description: 'description',
      tag: 'tag',
      system: 'system',
      hardware: 'hardware',
    },
  ],
]
```

这个配置定义了从 `package.json` 文件中读取项目信息的映射规则，将文件中的字段映射到内部信息对象中。

### 4.3 信息存储参数

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `infoStoreOptions.enabled` | `boolean` | `true` | 是否启用信息存储功能 |
| `infoStoreOptions.path` | `string` | `'release-info.json'` | 信息存储文件的路径 |
| `infoStoreOptions.transformMap` | `object` | `{}` | 信息转换映射规则 |
| `infoStoreOptions.releasedAtPattern` | `string` | `'YYYY-MM-DD HH:mm:ss'` | 发布时间的格式模式 |

### 4.4 发布文件名参数

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `releaseNameOptions.params` | `string[]` | `['name', 'version']` | 用于生成发布文件名的参数列表 |
| `releaseNameOptions.paramDelimiter` | `string` | `'-'` | 参数之间的分隔符 |
| `releaseNameOptions.releasedAtPattern` | `string` | `'YYYY-MM-DD'` | 文件名中包含的时间格式模式 |

### 4.5 文件移动参数

| 参数名 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `inputMoveOptions.items` | `Array` | `[]` | 需要移动或重命名的文件列表，每个元素包含 `source` 和 `target` 字段 |

## 5. 配置文件示例

下面是一个完整的配置文件示例 (`release.json`)：

```json
{
  "workspace": ".",
  "include": ["**/*"],
  "exclude": [
    "**/node_modules/**",
    "**/release/**",
    "**/deploy/**",
    "**/.git/**",
    "**/.vscode/**",
    "**/examples/**",
    "**/docs/**",
    "**/trash/**"
  ],
  "archiveType": "zip",
  "clean": true,
  "releasePathRelative": "cwd",
  "releasePath": "release",
  "getInfoOptions": {
    "from": [
      [
        "package.json",
        {
          "name": "name",
          "version": "version",
          "description": "description",
          "tag": "tag",
          "system": "system",
          "hardware": "hardware"
        }
      ]
    ]
  },
  "infoStoreOptions": {
    "enabled": true,
    "path": "release-info.json",
    "transformMap": {},
    "releasedAtPattern": "YYYY-MM-DD HH:mm:ss"
  },
  "releaseNameOptions": {
    "params": ["name", "version", "tag", "releasedAt", "system"],
    "paramDelimiter": "-",
    "releasedAtPattern": "YYYY-MM-DD"
  },
  "inputMoveOptions": {
    "items": []
  }
}
```

## 6. 高级功能

### 6.1 动态生成发布文件名

通过配置 `releaseNameOptions.params`，可以灵活组合多个参数来生成发布文件名。例如：

```json
"releaseNameOptions": {
  "params": ["name", "version", "tag", "system"],
  "paramDelimiter": "-"
}
```

假设 `name` 为 "my-app"，`version` 为 "1.0.0"，`tag` 为 "beta"，`system` 为 "linux"，那么生成的发布文件名将为 `my-app-1.0.0-beta-linux.zip`（假设 `archiveType` 为 `zip`）。

### 6.2 文件移动与重命名

通过配置 `inputMoveOptions.items`，可以在打包过程中移动或重命名文件：

```json
"inputMoveOptions": {
  "items": [
    {
      "source": "src/config.example.json",
      "target": "src/config.json"
    },
    {
      "source": "scripts",
      "target": "bin"
    }
  ]
}
```

### 6.3 项目信息管理

Release Tools 会自动从配置的来源获取项目信息，并可选择性地存储到指定文件中，方便后续查询和跟踪发布历史。

## 7. 常见问题与解决方案

### 7.1 如何只打包特定的文件？

通过配置 `include` 和 `exclude` 参数，使用 glob 语法来精确控制要打包的文件：

```json
{
  "include": ["src/**/*", "package.json", "README.md"],
  "exclude": ["src/tests/**", "**/*.log"]
}
```

### 7.2 如何更改发布文件的存放位置？

通过配置 `releasePathRelative` 和 `releasePath` 参数来控制发布文件的存放位置：

```json
{
  "releasePathRelative": "workspace",
  "releasePath": "dist/releases"
}
```

这会将发布文件存放在工作空间目录下的 `dist/releases` 文件夹中。

### 7.3 如何自定义发布文件的命名规则？

通过配置 `releaseNameOptions` 参数来自定义发布文件的命名规则：

```json
{
  "releaseNameOptions": {
    "params": ["name", "version", "releasedAt"],
    "paramDelimiter": "_",
    "releasedAtPattern": "YYYYMMDD"
  }
}
```

## 8. 注意事项

1. 使用时请确保配置正确的 `workspace` 路径，否则可能会打包错误的文件。
2. 对于大型项目，建议合理配置 `include` 和 `exclude` 参数，以提高打包效率。
3. 在 CI/CD 环境中使用时，建议通过配置文件来管理参数，以保持一致性。
4. 如果启用了信息存储功能，请确保程序对存储路径有写权限。

## 9. 附录

### 9.1 相关链接

- [GitHub 仓库](https://github.com/radiorz/project-base/tree/main/tools/release-tools)

### 9.2 开发命令

```bash
# 构建项目
pnpm run build

# 开发模式运行
pnpm run dev

# 开发模式运行CLI
pnpm run dev:cli

# 运行测试
pnpm run test

# 运行示例
pnpm run test:example

# 更新依赖
pnpm run deps:update
```